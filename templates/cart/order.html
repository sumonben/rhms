{% extends 'basepage/basepage.html' %}
{% load static  %}

    <!-- Page Preloder -->
    <!-- <div id="preloder">
        <div class="loader"></div>
    </div> -->

    <!-- Offcanvas Menu Section Begin -->
    
    {% block content %}
    <style>
      .form-control {
         min-height: 33px;
      }
      
      /* Base responsive styles */
      * {
         box-sizing: border-box;
      }
      
      main.home {
         max-width: 100vw;
         overflow-x: hidden;
         padding: 50px 15px 20px;
      }
      
      .Checkout_checkout__UBWBo {
         width: 100%;
         max-width: 100%;
         display: grid;
         grid-template-columns: 1fr;
         gap: 20px;
      }
      
      .Card_card__D-XC2 {
         width: 100%;
         padding: 15px;
         overflow-x: auto;
      }
      
      /* Table responsive */
      .table-responsive {
         overflow-x: auto;
         -webkit-overflow-scrolling: touch;
      }
      
      .cart_summary {
         min-width: 700px;
      }
      
      /* Desktop layout - two columns */
      @media (min-width: 992px) {
         main.home {
            padding: 50px 30px 20px;
         }
         
         .Checkout_checkout__UBWBo {
            grid-template-columns: 1fr 1fr;
            gap: 30px;
         }
         
         .Checkout_checkout__UBWBo > div:first-child {
            grid-column: 1;
         }
         
         .Checkout_checkout__UBWBo > div:last-child {
            grid-column: 2;
         }
      }
      
      /* Tablet landscape */
      @media (max-width: 991px) {
         main.home {
            padding: 40px 20px;
         }
         
         .Checkout_checkout__UBWBo {
            grid-template-columns: 1fr;
         }
         
         .Card_card__D-XC2 {
            padding: 15px;
         }
      }
      
      /* Tablet portrait and mobile */
      @media (max-width: 767px) {
         main.home {
            padding: 30px 10px;
         }
         
         .Checkout_checkout__UBWBo {
            grid-template-columns: 1fr;
            gap: 15px;
         }
         
         .Card_card__D-XC2 {
            padding: 10px;
         }
         
         .cart_summary thead th {
            font-size: 12px;
            padding: 8px 4px;
         }
         
         .cart_summary tbody td {
            font-size: 12px;
            padding: 8px 4px;
         }
         
         .cart_product img {
            max-width: 60px;
         }
         
         .discount-cupon-payment {
            width: 100% !important;
         }
         
         .discount-cupon-payment input {
            width: 60% !important;
         }
         
         .discount-cupon-payment button {
            width: 38% !important;
         }
         
         .Input_form_control__k2Lye {
            margin-bottom: 15px;
         }
         
         .PaymentOptions_payment-options__wPRGy {
            width: 100%;
         }
         
         .PaymentOption_payment-option__6-0db {
            padding: 12px;
            margin-bottom: 10px;
         }
         
         .PaymentOption_payment-option__6-0db label {
            font-size: 14px;
         }
         
         .PaymentOption_payment-option__6-0db img {
            height: 25px !important;
            margin: 0 8px !important;
         }
         
         .Action_action__K65rE button {
            width: 100% !important;
            padding: 15px;
         }
      }
      
      /* Small mobile devices */
      @media (max-width: 575px) {
         main.home {
            padding: 20px 5px;
         }
         
         .Checkout_checkout__UBWBo {
            gap: 10px;
         }
         
         .Card_card__D-XC2 {
            padding: 8px;
         }
         
         .cart_summary {
            font-size: 11px;
            min-width: 600px;
         }
         
         .cart_product img {
            max-width: 50px;
         }
         
         .form-control {
            font-size: 12px;
            padding: 5px;
         }
         
         .Input_form_control__k2Lye input,
         .Input_form_control__k2Lye select {
            font-size: 14px;
            padding: 10px;
         }
         
         .PaymentOption_payment-option__6-0db {
            padding: 10px;
         }
         
         .PaymentOption_payment-option__6-0db img {
            height: 20px !important;
            margin: 0 5px !important;
         }
         
         .PaymentOption_payment-option__6-0db span {
            font-size: 13px !important;
         }
      }
      
      /* Extra small devices */
      @media (max-width: 480px) {
         .cart_summary thead th,
         .cart_summary tbody td {
            font-size: 10px;
            padding: 5px 2px;
         }
         
         .cart_summary {
            min-width: 550px;
         }
         
         h3 {
            font-size: 16px !important;
         }
      }
      
      /* Ensure form elements are responsive */
      input[type="text"],
      input[type="email"],
      input[type="date"],
      select,
      textarea {
         width: 100%;
         max-width: 100%;
      }
      
      /* Flexbox utilities */
      .flex {
         display: flex;
      }
      
      .flex-column {
         flex-direction: column;
      }
      
      .gap-16 {
         gap: 16px;
      }
      
      @media (max-width: 767px) {
         .gap-16 {
            gap: 10px;
         }
      }
      
      /* Override inline styles for mobile */
      @media (max-width: 991px) {
         main.home.option2.homeServicePadding {
            padding: 40px 15px 20px 15px !important;
            overflow-x: hidden !important;
         }
         
         .Checkout_checkout__UBWBo {
            display: flex !important;
            flex-direction: column !important;
            width: 100% !important;
         }
         
         .Checkout_checkout__UBWBo > div {
            width: 100% !important;
            max-width: 100% !important;
         }
      }
      
      @media (max-width: 767px) {
         main.home.option2.homeServicePadding {
            padding: 30px 10px 20px 10px !important;
         }
         
         .Payment_payment__cEYmj {
            width: 100% !important;
            overflow-x: auto;
         }
         
         .Payment_payment__cEYmj td {
            padding: 10px 5px !important;
            font-size: 13px !important;
         }
         
         .discount-cupon-payment form {
            display: flex !important;
            width: 100% !important;
            gap: 5px;
         }
         
         .discount-cupon-payment input {
            flex: 1 !important;
            min-width: 0 !important;
         }
         
         .discount-cupon-payment button {
            flex-shrink: 0 !important;
            width: auto !important;
            padding: 10px 15px !important;
         }
      }
      
      @media (max-width: 575px) {
         main.home.option2.homeServicePadding {
            padding: 20px 5px 20px 5px !important;
         }
         
         .Card_card__D-XC2 {
            margin-bottom: 10px;
         }
         
         .Address_address__yw7QK > div {
            display: flex;
            flex-direction: column;
            gap: 0;
         }
         
         .Policy_order-policy__V+UQp p {
            font-size: 12px !important;
            margin: 5px 0 !important;
         }
      }
      </style>
<main class="home option2 homeServicePadding" style="overflow-x: hidden; padding-top: 50px; max-width: 100vw;">
   <div style="max-width: 100%; overflow-x: hidden;">
   <form action="{% url 'order_cart' %}" method="POST" style="width: 100%;">
    {% csrf_token %}
   <div class="Checkout_checkout__UBWBo relative" id="checkout">
      <div class="flex flex-column gap-16">
         <div class="Card_card__D-XC2 undefined false">
            <table class="table table-responsive cart_summary">
               <thead>
                  <tr class="Payment_payment__row__v5dNA">
                     <th class="cart_product text-semibold">Product</th>
                     <th class="text-semibold">Description</th>
                     <th class="text-semibold">Check In</th>
                     <th class="text-semibold">Check Out</th>
                     <th class="unit_price text-semibold">Price</th>
                     <th class="text-semibold">Amount</th>
                     <th class="action text-semibold">Action</th>
                  </tr>
               </thead>
               <tbody>
                {% for room in cart_rooms %}
                  <tr>
                     <td class="cart_product"><a href="{% url 'room_details' room.id %}"><img src="{{ room.main_image.url }}" alt="Product"></a></td>
                     <td class="cart_description">
                        <p class="product-name"><a>{{ room.name_eng }}</a></p>
                     </td>
                     <td class="cart_date" style="text-align: center; width: 12%;">
                        <input type="date" class="form-control" name="check_in_{{ room.id }}" value="" required>
                     </td>
                     <td class="cart_date" style="text-align: center; width: 12%;">
                        <input type="date" class="form-control" name="check_out_{{ room.id }}" value="" required>
                     </td>
                     <td class="price" style="text-align: center; width: 12%;"><span>৳ {{ room.price }}</span></td>
                     <td class="price room-total-{{ room.id }}" style="text-align: center; width: 15%;" data-room-id="{{ room.id }}" data-price="{{ room.price }}"><span>৳ <span class="room-amount">{{ room.price }}</span></span></td>
                     <td class="action"><a href="javascript:void(0);" class="icon-remove remove-from-cart" data-room-id="{{ room.id }}" style="font-size: 1.5rem; color: red; cursor: pointer;"><i class="fa fa-remove" aria-hidden="true"></i></a></td>
                  </tr>
                {% endfor %}
               </tbody>
               <tfoot>
                  <tr>
                     <td colspan="5" class="text-semibold">Total</td>
                     <td colspan="2" class="text-semibold" style="text-align: center;">৳ <span id="grand-total">{{ total_cart_amount }}</span></td>
                  </tr>
               </tfoot>
            </table>
         </div>
         <div class="Card_card__D-XC2 undefined false">
            <table class="Payment_payment__cEYmj">
               <tbody>
                  <tr class="Payment_payment__row__v5dNA">
                     <td>Amount (tax incl.)</td>
                     <td id="amount-tax-incl">{{ total_cart_amount }}</td>
                     <td>TK</td>
                  </tr>
                  <tr class="Payment_payment__row__v5dNA">
                     <td>Total Amount</td>
                     <td id="final-total">{{ total_cart_amount }}</td>
                     <td>TK</td>
                  </tr>
               </tbody>
            </table>
         </div>
         
         <div class="discount-cupon-payment">
            <form id="discount_codeSubmit"><input type="text" id="discount_code" placeholder="Coupon Code..."><button type="button">Apply</button></form>
         </div>
      </div>
      
      <div class="flex flex-column gap-16">
         <div class="Card_card__D-XC2 Address_address__yw7QK false">
            <div>
               <div class="Input_form_control__k2Lye false undefined"><label for="Receiver Name"><span class="Input_form_control__label__SOQJo">Receiver Name <span class="Input_form_control__label__option__YxCA5">(Required)</span></span><input type="text" id="receiver_name" name="receiver_name"  value="" required><small> </small></label></div>
               <div class="Input_form_control__k2Lye Input_form_control--error__HPRMG undefined"><label for="Receiver Phone"><span class="Input_form_control__label__SOQJo">Receiver Phone <span class="Input_form_control__label__option__YxCA5">(Required)</span></span><input type="text" id="receiver_phone" name="receiver_phone" required><small> </small></label></div>
            </div>
            <div>
               <div class="Input_form_control__k2Lye false undefined"><label for="Receiver Email"><span class="Input_form_control__label__SOQJo">Email Address <span class="Input_form_control__label__option__YxCA5">(Optional)</span></span><input type="email" id="receiver_email" name="receiver_email"  value="" placeholder="example@email.com"><small> </small></label></div>
            </div>
            <div>
               <div class="Input_form_control__k2Lye false undefined"><label for="Number of Guests"><span class="Input_form_control__label__SOQJo">Number of Guests <span class="Input_form_control__label__option__YxCA5">(Required)</span></span><input type="number" id="number_of_guests" name="number_of_guests" value="1" min="1" required><small> </small></label></div>
            </div>
            <div>
               

               <div class="Select_form_control__-W7rB" >
                  <label for="Region"><span class="Select_form_control__label__8gi3V">Region <span class="Select_form_control__label__option__zbnTX">(Required)</span></span></label>
                  <div class="loginBox" style="font-size: 20px;">
                       {{ address_form.division }}
                     
                  </div>
               </div>
               <div class="Select_form_control__-W7rB">
                  <label for="City"><span class="Select_form_control__label__8gi3V">City <span class="Select_form_control__label__option__zbnTX">(Required)</span></span></label>
                  <div class="loginBox" style="font-size: 20px;">
                       {{ address_form.district }}
                     
                  </div>
               </div>
               <div class="Select_form_control__-W7rB">
                  <label for="Area"><span class="Select_form_control__label__8gi3V">Area <span class="Select_form_control__label__option__zbnTX">(Optional)</span></span></label>
                  <div class="loginBox" style="font-size: 20px;">
                      {{ address_form.upazilla }}
                  </div>
               </div>
            </div>
            <div>
               <div class="Textarea_form_control__oik5R">
                  <label for="Address">
                     <span class="Textarea_form_control__label__hBHV6">Address <span class="Textarea_form_control__label__option__JTJT7">(Required)</span></span>
                  </label>
                  {{ address_form.others }}
                  <small> </small>
               </div>
            </div>
         </div>
         <div class="Card_card__D-XC2 relative false">
            <div class="prescription_order_section">
               <div class="file_uploader" style="max-width: 33.33%;"><input class="display-none--important" type="file" name="" id=""><button class="Button_button__Poz4v false false " type="button">Upload NID (optional)</button></div>
            </div>
         </div>
      </div>
      <div class="Checkout_grid__span__2__wynh- flex flex-column gap-16">
         <div class="PaymentOptions_payment-options__wPRGy">
            {% comment %} <div class="PaymentOption_payment-option__6-0db PaymentOption_active__3zfwe"><label class=""><input type="radio" name="payment-option" class="PaymentOption_payment-option__6-0db">Cash On Delivery</label></div> {% endcomment %}
         </div>
         <div class="Policy_order-policy__V+UQp">
            <p class="OrderNotice">*** SSL-commerz payment ensure secure payment</p>
            <p class="OrderNotice">***  We follow the government residential hotel policy</p>
         </div>
         <div class="Action_action__K65rE">
            {% comment %} <div class="AutoOrder_auto_order__V0y5K"><label for="auto-order"><input type="checkbox" name="autoOrder" id="auto-order">Auto Order After 28 Days</label></div> {% endcomment %}
            <button class="Button_button__Poz4v false false " type="submit">Place Order</button>
         </div>
      </div>
   </div>
   </form>
   </div>
</main>

<script>
    function myFunctionTeacher(id){
      var csrfToken = $('[name="csrfmiddlewaretoken"]').val();
      
      var division=document.getElementById(id).value;
      //alert(division);
      var $j = jQuery.noConflict();
    
      url="{% url 'get_district'%}";
      //alert(url);
      
        $.ajax({
        type: 'POST',
        url: "{% url 'get_district'%}",  // Adjust the URL as per your project structure
        data: {"id":id, "value":division},
        headers: {
               'X-CSRFToken': csrfToken
           },
       
        success: function (response) {
         
             //document.getElementById("student_form").reset();
            if (response.status === 'success') {
            

              if(id =='id_division'){
              $("#id_district option").remove();
              $("#id_district").append('<option '+'value="">'+ '-----------' +'</option>');
                    for (var i = response.district.length - 1; i >= 0; i--) {
                                  $("#id_district").append('<option '+'value="'+response.district[i].id+'">'+ response.district[i].name_en +'</option>');
                              }
                }
              if(id=='id_district'){
  
                $("#id_upazilla option").remove();
              $("#id_upazilla").append('<option '+'value="">'+ '-------------' +'</option>');
                    for (var i = response.district.length - 1; i >= 0; i--) {
                                  $("#id_upazilla").append('<option '+'value="'+response.district[i].id+'">'+ response.district[i].name_en +'</option>');
                              }
  
              }
            } else {
             ///alert("Success message not found");
                    
                }
                
        },
        error: function (xhr, status, error) {
           
            // var err = eval("(" + xhr.responseText + ")");
            // alert(err.Message);
        }
    });
  
      
    } 
    </script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script>
    // Dynamic total calculation based on check-in and check-out dates
    $(document).ready(function() {
        // Function to calculate nights between two dates
        function calculateNights(checkIn, checkOut) {
            if (!checkIn || !checkOut) return 1;
            
            const start = new Date(checkIn);
            const end = new Date(checkOut);
            const nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            
            return nights > 0 ? nights : 1;
        }
        
        // Function to update room total
        function updateRoomTotal(roomId) {
            const checkIn = $('input[name="check_in_' + roomId + '"]').val();
            const checkOut = $('input[name="check_out_' + roomId + '"]').val();
            const roomPrice = parseFloat($('.room-total-' + roomId).data('price'));
            
            const nights = calculateNights(checkIn, checkOut);
            const roomTotal = roomPrice * nights;
            
            $('.room-total-' + roomId + ' .room-amount').text(roomTotal.toFixed(0));
            
            updateGrandTotal();
        }
        
        // Function to update grand total
        function updateGrandTotal() {
            let grandTotal = 0;
            
            $('[class*="room-total-"]').each(function() {
                const amount = parseFloat($(this).find('.room-amount').text());
                if (!isNaN(amount)) {
                    grandTotal += amount;
                }
            });
            
            $('#grand-total').text(grandTotal.toFixed(0));
            $('#amount-tax-incl').text(grandTotal.toFixed(0));
            $('#final-total').text(grandTotal.toFixed(0));
        }
        
        // Listen for date changes
        $('input[type="date"]').on('change', function() {
            const name = $(this).attr('name');
            const match = name.match(/_(check_in|check_out)_(\d+)/);
            
            if (match) {
                const roomId = match[2];
                updateRoomTotal(roomId);
            }
        });
        
        // Initial calculation when dates are set
        {% for room in cart_rooms %}
        $('input[name="check_in_{{ room.id }}"], input[name="check_out_{{ room.id }}"]').on('change', function() {
            updateRoomTotal('{{ room.id }}');
        });
        {% endfor %}
        
        // Handle remove from cart
        $('.remove-from-cart').on('click', function(e) {
            e.preventDefault();
            const roomId = $(this).data('room-id');
            const csrfToken = $('[name="csrfmiddlewaretoken"]').val();
            
            if (confirm('Are you sure you want to remove this room from cart?')) {
                $.ajax({
                    type: 'POST',
                    url: '/cart/remove/' + roomId + '/',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            // Remove the row from max-cart display first
                            $('#cart_body').find('input[value="' + roomId + '"]').closest('tr').remove();
                            
                            // Remove the row from the order page table
                            $('tr').has('[data-room-id="' + roomId + '"]').fadeOut(300, function() {
                                $(this).remove();
                                updateGrandTotal();
                                
                                // Update cart counters based on cart_body
                                const remainingItems = $('#cart_body tr').length;
                                $('#number_of_item_mini').text(remainingItems);
                                $('#number_of_item').text(remainingItems);
                                $('#total_item_max_cart').text(remainingItems);
                                
                                // Update cart totals
                                const newTotal = $('#grand-total').text();
                                $('#mini_cart_total').text(newTotal);
                                $('#total_amount_max_cart').text(newTotal);
                                
                                // Reload if cart is empty
                                if (remainingItems === 0) {
                                    location.reload();
                                }
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error removing item from cart. Please try again.');
                    }
                });
            }
        });
    });
    </script>

{% endblock content %}